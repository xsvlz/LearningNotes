# SQL事务

事务（Transaction）是并发控制的基本单位。所谓的事务，它是一个操作序列，这些操作要么都执行，要么都不执行，它是一个不可分割的工作单位。事务是数据库维护数据一致性的单位，在每个事务结束时，都能保持数据一致性。

### 事务的ACID特性：

- **原子性**  
    事务中包含的操作被看做一个逻辑单元，这个逻辑单元中的操作要么全部成功，要么全部失败
- **一致性**  
    事物完成时，数据必须是一致的，也就是说，和事物开始之前，数据存储中的数据处于一致状态。保证数据的无损
- **隔离性**  
    对数据进行修改的多个事务是彼此隔离的。这表明事务必须是独立的，不应该以任何方式以来于或影响其他事务
- **持久性**  
    事务完成之后，它对于系统的影响是永久的，该修改即使出现系统故障也将一直保留，真实的修改了数据库

### 并发产生的三种数据库不一致性：

1. **丢失修改**：两个事务 T1 和 T2 读入同一个数据并修改， T2 提交的结果破坏了 T1 提交的结果，导致了 T1 的修改被丢失。典型例子：卖票。（但实际上在mysql中任何的DML操作都会被加上行锁或更粗粒度的锁，因此这种情况即使在读未提交的隔离级别也是不会产生的。也就是数据库本身不会产生这个问题，但是在多用户操作的业务逻辑中有可能出现这种情况）
2. **不可重复读**：不可重复读指的是事务T1读取数据后，事务T2执行更新操作，使T1无法再现前一次读取的结果。其中又分为三种情况：
   
    1. 事务T1读取了某一数据后，事务T2对其做了修改，当事务T1再次读数据时，得到了与前一次不同的值。
    2. 事务T1读取了某一数据后，事务T2删除了其中的记录，当事务T1再次读数据时，发现某些记录神秘消失了。
    3. 事务T1读取了某一数据后，事务T2插入了一些新的记录，当事务T1再次读数据时，发现多了一些记录。
    
    其中，后两种被称为==幻读==
    
1. **读脏数据**：读“脏”数据只得是事务 T1 修改了某一数据，并将其写回磁盘，事务 T2 再读取这一数据后，T1 由于某种原因撤销了操作，恢复原值，这时 T2 读到的数据就和数据库中的数据不一致，称为读“脏”数据

### 数据库事务的隔离级别[^ref]

[^ref]: 参考掘金作者：司徒公子<br>链接：https://juejin.im/post/5c9756296fb9a070ad504a05

| 隔离级别 | 丢失修改 | 脏读 | 不可重复读 | 幻读 |
| :------: | :------: | :--: | :--------: | :--: |
| 读未提交 |   避免   |      |            |      |
| 读已提交 |   避免   | 避免 |            |      |
| 可重复读 |   避免   | 避免 |    避免    |      |
|  串行化  |   避免   | 避免 |    避免    | 避免 |

#### 读未提交（READ UNCOMMITTED）

在READ UNCOMMITTED级别，事务的修改，即使没有提交，对其他事务也都是可见的。事务可以读取未提交的数据。这个级别的隔离会导致很多问题，虽然在性能方面是最优的，但是缺乏其他级别的很多好处，所以这种隔离的级别很少在实际中应用。

#### 读已提交（READ COMMITTED）

大多数数据库系统默认的隔离级别都是READ COMMITTED ( _但MySQL不是_ )。
"读已提交"简单的定义：一个事务只能看见已经提交的事务的修改结果。
换句话说，一个事务从开启事务到提交事务之前，对其他事务都是不可见的，因此在同一个事务中的两次相同查询结果可能不一样。故这种隔离级别有时候也叫不可重复读

#### 可重复读（REPEATABLE READ）

可重复读是 _MySQL_ 的默认事务隔离级别。
可重复读解决了脏读的问题，该级别保证了在同一次事务中多次查询相同的语句结果是一致的，即使其他事务已经提交，对当前事务来说仍是不可见。该隔离级别无法避免产生幻行的问题（例如两个事务同时插入一条唯一索引的行，其中一个插入成功并提交后，另一个事务看不到该行，但也无法插入）。
MySQL的InnoDB引擎通过多版本并发控制（MVCC）解决了幻读的问题。

#### 串行化（SERIALIZABLE）

SERIALIZABLE是最高的隔离级别，它通常通过强制事务串行，避免了前面说的幻读问题。简单来说，"可串行化"会在读取的每一行数据上都加锁，所以可能会导致大量的锁等待和超时问题，所以在实际的生产环境中也很少会用到这个隔离级别，只有在非常需要确保数据的一致性切可以接受没有并发的情况下，才会考虑使用这个隔离级别。