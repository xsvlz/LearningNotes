# HTTP/HTTPS分析

HTTP协议是应用层的面向对象的协议，HTTP具有简单快速、灵活、无连接、无状态等特点。它使用TCP协议作为运输支撑协议。

**无连接**，是指每次连接只处理一个请求。服务器处理完客户的请求，并收到客户的应答后，即断开连接。这在早期的互联网是通用的做法，现在如果在请求头中加入`Connection:keep-alive`，就可以建立与服务器的持续链接，即后续的请求对象也可以使用相同的链接传输。对于传输对象较多的静态web页面来说可以很好的提升传输效率。

**无状态**，是指协议不维护双方的状态，客户端给服务器发送HTTP请求后，服务器根据请求发送相应数据，但是发送的过程中不会记录任何信息。这意味着每个请求都是独立的，如果后续的处理需要之前的信息，那就必须重传。
尽管HTTP协议本身没有提供对连接状态的支持，但可以使用Cookie和Session技术来保持HTTP的连接状态。

## HTTP数据传输流程

假设我们要访问一个页面: http://example.com/index.html。 我们的请求数据会经过如下过程：

1. 地址解析

    当使用浏览器请求这个页面的时候，浏览器会根据访问的URL分理出协议名、主机名、端口、URI等部分。例如我们访问上述页面会得到以下解析的结果：
    - 协议：HTTP
    - 主机名：example.com
    - 端口：80
    - URI：/index.html
      

    同时在这一步，需要通过DNS得到 example.com的主机IP地址

2. 封装HTTP请求

    将上述信息和请求信息等组装成HTTP报文，包含请求行、首部行、实体体等。

3. 封装成TCP报文并建立连接

    将HTTP报文加上首部，封装成为TCP报文。然后通过三次握手与服务器建立TCP连接。

4. 客户端发送请求命令

    建立连接之后，客户端发送一个HTTP请求给服务器

5. 服务器响应。

    服务器接收到请求后，发送回相应的响应报文。包括状态行、首部行、实体体等信息

6. 服务器关闭TCP连接

    通常情况下，web服务器向客户端发送数据后，它就要关闭TCP连接，除非在首部信息中加入了`Connection:keep-alive`，这样TCP连接就在发送后仍然保持打开状态，后续浏览器可以通过相同的连接发送请求，在请求对象较多时可以节省建立连接的开销。

## HTTPS协议

HTTPS，全称为Hypertext Transfer Protocal over Secure Socket Layer，即建立在SSL层之上的HTTP协议。顾名思义，它在HTTP协议之下加入了SSL层作为它的安全层，是HTTP协议的安全版。
HTTPS协议使用的默认端口为443

### 什么是SSL？[^1]

[^1]: 参考自掘金作者：nephen <br>链接：https://juejin.im/post/5c1312eee51d451a87527bfa

SSL是指安全套接字层，它是一项标准技术，可以确保互联网的连接安全，保护两个系统之间发送的任何敏感数据，防止他人读取或修改任何传输的信息。

不使用安全协议的HTTP通信，所有的信息明文传输，带来了几大风险：
- 窃听风险：第三方可以获取通信内容
- 篡改风险：第三方可以修改通信内容
- 冒充风险：第三方可以冒充他人身份进行通信

而SSL则可以达到如下目的：

- 所有信息都是加密传播，第三方无法窃听。
- 具备校验机制，一旦发现信息被篡改，通信双方会立刻发现。
- 使用证书来防止身份冒充。

#### SSL证书

SSL协议的基本思路是采用公钥加密法，即客户端向服务器索要公钥，使用公钥对信息进行加密，服务器收到密文后，使用自己的私钥进行解密。

如何保证公钥不被篡改？答案是：将公钥放在数字证书中。只要证书是可信的，公钥就是可信的。SSL 证书就是遵守 SSL协议，由受信任的数字证书颁发机构CA，在验证服务器身份后颁发，具有服务器身份验证和数据传输加密功能。

### 什么时候使用SSL证书？

1. 我们在点击web站点的时候，比如输入https://www.domain.com ，进行dns解析后web服务器进行响应，web服务器自动传送https://www.domain.com 网站的数字证书给用户，上文说到了，证书是安装在web服务器里面的，证书里面含有公钥，所以这里相当于服务器把公钥传递给了客户端，当然服务器那里还有自己的私钥。
2. 客户端是使用浏览器进行操作的，不同版本的浏览器自动产生40位或128位的会话密钥，用于对交易的信息进行加密，也就是说客户向服务器索要公钥后还要与服务器协商生成一个“会话秘钥”。如下图，第三步获取到crt证书后，需要检验证书是否有效，如果无效则会显示警告信息，有效则生成一个随机数，即会话密钥，这个会话密钥再使用crt里面的公钥加密后传输给web服务器，服务器使用自己的私钥进行解密，获取浏览器生成的随机“会话密钥”，现在客户端服务器都知道这个“会话密钥”了，后续通信都用这个会话密钥进行加密通信了。
    ![](http://img.longzhuang.top/20200717154044.jpg)



